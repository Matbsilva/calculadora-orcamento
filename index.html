<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Orçamento de Obra</title>
    <link rel="stylesheet" href="style.css">
    <!-- Favicon links (se você não tiver os arquivos, pode remover estas 4 linhas) -->
    <link rel="apple-touch-icon" sizes="180x180" href="favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon/favicon-16x16.png">
    <link rel="manifest" href="favicon/site.webmanifest">

    <!-- CDN do Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- CDN do Frappe Gantt (JS e CSS) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.css">
    <script src="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.js"></script>
</head>
<body>
    <header>
        <h1>Calculadora de Orçamento de Obra</h1>
        <div class="header-controls">
            <button id="btnSalvarOrcamento" class="btn-header">Salvar Orçamento</button>
            <label for="inputCarregarOrcamento" class="btn-header btn-file-label">
                Carregar Orçamento
                <input type="file" id="inputCarregarOrcamento" accept=".json" style="display: none;">
            </label>
            <button id="btnResetarAplicacao" class="btn-header btn-danger">Resetar Aplicação</button>
        </div>
    </header>

    <main>
        <nav class="tab-nav">
            <button class="tab-link active" data-tab="configuracoes" id="tab-link-configuracoes" role="tab" aria-selected="true" tabindex="0" aria-controls="configuracoes">Configurações</button>
            <button class="tab-link" data-tab="calculadora" id="tab-link-calculadora" role="tab" aria-selected="false" tabindex="-1" aria-controls="calculadora">Calculadora</button>
            <button class="tab-link" data-tab="simulacoes-bdi" id="tab-link-simulacoes-bdi" role="tab" aria-selected="false" tabindex="-1" aria-controls="simulacoes-bdi">Simulações BDI</button>
            <button class="tab-link" data-tab="resumo" id="tab-link-resumo" role="tab" aria-selected="false" tabindex="-1" aria-controls="resumo">Resumo</button>
            <button class="tab-link" data-tab="listas" id="tab-link-listas" role="tab" aria-selected="false" tabindex="-1" aria-controls="listas">Listas</button>
            <button class="tab-link" data-tab="curva-abc" id="tab-link-curva-abc" role="tab" aria-selected="false" tabindex="-1" aria-controls="curva-abc">Curva ABC</button>
            <button class="tab-link" data-tab="cronograma" id="tab-link-cronograma" role="tab" aria-selected="false" tabindex="-1" aria-controls="cronograma">Cronograma Estimado</button>
        </nav>

        <!-- Aba Configurações -->
        <div id="configuracoes" class="tab-content active" role="tabpanel" aria-labelledby="tab-link-configuracoes">
            <h2>Configurações Gerais e Custos</h2>
            <div class="config-grid">
                <div class="config-section">
                    <h3>Custos de Mão de Obra (R$/Dia)</h3>
                    <div class="input-group"><label for="inputCustoPedreiro">Pedreiro:</label><input type="text" id="inputCustoPedreiro" placeholder="R$ 0,00"><span class="error-message" id="inputCustoPedreiroError"></span></div>
                    <div class="input-group"><label for="inputCustoServente">Servente:</label><input type="text" id="inputCustoServente" placeholder="R$ 0,00"><span class="error-message" id="inputCustoServenteError"></span></div>
                    <div class="input-group"><label for="inputCustoEncarregado">Encarregado:</label><input type="text" id="inputCustoEncarregado" placeholder="R$ 0,00"><span class="error-message" id="inputCustoEncarregadoError"></span></div>
                    <div class="input-group"><label for="inputCustoImpermeabilizador">Impermeabilizador:</label><input type="text" id="inputCustoImpermeabilizador" placeholder="R$ 0,00"><span class="error-message" id="inputCustoImpermeabilizadorError"></span></div>
                    <div class="input-group"><label for="inputCustoCarpinteiro">Carpinteiro:</label><input type="text" id="inputCustoCarpinteiro" placeholder="R$ 0,00"><span class="error-message" id="inputCustoCarpinteiroError"></span></div>
                    <div class="input-group"><label for="inputCustoArmador">Armador:</label><input type="text" id="inputCustoArmador" placeholder="R$ 0,00"><span class="error-message" id="inputCustoArmadorError"></span></div>
                </div>
                <div class="config-section">
                    <h3>Preços de Materiais (Unidade)</h3>
                    <div id="materialPricesConfigContainer">
                        <!-- Preços dos materiais serão populados aqui por config.js -->
                    </div>
                </div>
                <div class="config-section">
                    <h3>Parâmetros Gerais</h3>
                    <div class="input-group"><label for="inputBdiFinal">BDI Final Adotado (%):</label><input type="text" id="inputBdiFinal" placeholder="0%"><span class="error-message" id="inputBdiFinalError"></span></div>
                    <div class="input-group"><label for="inputAreaObra">Área da Obra (m²):</label><input type="text" id="inputAreaObra" placeholder="1" aria-describedby="areaObraDesc"><span class="error-message" id="inputAreaObraError"></span><small class="sr-only" id="areaObraDesc">Insira a área total da obra em metros quadrados. Apenas números inteiros. Mínimo 1m².</small></div>
                </div>
            </div>
            <div class="config-actions"><button id="btnSalvarConfig" class="btn-primary">Aplicar Configurações</button><button id="btnCarregarConfigPadrao" class="btn-secondary">Carregar Padrão</button></div>
        </div>

        <!-- Aba Calculadora -->
        <div id="calculadora" class="tab-content" role="tabpanel" aria-labelledby="tab-link-calculadora">
            <h2>Calculadora de Custos Diretos</h2>
            <div class="calculadora-controls"><div class="input-group"><label for="selectServico">Adicionar Serviço/Composição:</label><select id="selectServico"><option value="">Selecione uma composição...</option></select><button id="btnAdicionarServico" class="btn-primary">Adicionar</button></div><div class="input-group search-group"><label for="inputPesquisaServico">Pesquisar Serviço na Tabela:</label><input type="search" id="inputPesquisaServico" placeholder="Digite para filtrar..."></div></div>
            <div class="bdi-display-container">
                <span>BDI Adotado para Preço de Venda dos Itens: <strong id="bdiAdotadoDisplayCalculadora">0,00%</strong></span>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Item da Composição (Serviço)</th>
                            <th>Ref.</th>
                            <th>U.M.</th>
                            <th>Qtde.</th>
                            <th>Custo Mat. Unit. (R$)</th>
                            <th>Custo M.O. Unit. (R$)</th>
                            <th>Custo Unit. Total (R$)</th>
                            <th>Custo Mat. Total (R$)</th>
                            <th>Custo M.O. Total (R$)</th>
                            <th>Custo Total (R$)</th>
                            <th>Preço Venda Item (R$)</th>
                            <th>HH Prof. Total</th>
                            <th>HH Ajud. Total</th>
                            <th>Peso Total (kg)</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaCalculadoraItens"></tbody>
                    <tfoot id="tabelaCalculadoraRodape">
                        <!-- Rodapé será populado por calculadora.js -->
                    </tfoot>
                </table>
            </div>
        </div>

        <!-- Aba Simulações BDI -->
        <div id="simulacoes-bdi" class="tab-content" role="tabpanel" aria-labelledby="tab-link-simulacoes-bdi">
            <h2>Simulações Detalhadas de BDI e Precificação</h2>
            <div class="bdi-simulation-bloco">
                <h3>BLOCO 1: SIMULAÇÃO - CUSTOS INDIRETOS E LUCRO SOBRE MÃO DE OBRA</h3>
                <div class="bdi-simulation-grid-container">
                    <div class="input-group"><label for="simCustoDiretoMO">Custo Direto Mão de Obra (R$):</label><input type="text" id="simCustoDiretoMO" readonly placeholder="R$ 0,00"></div>
                    <div class="input-group"><label for="simAdminMO">% Administração sobre M.O.:</label><input type="text" id="simAdminMO"><span class="error-message" id="simAdminMOError"></span></div>
                    <div class="input-group"><label for="simRiscoMO">% Risco sobre M.O.:</label><input type="text" id="simRiscoMO"><span class="error-message" id="simRiscoMOError"></span></div>
                    <div class="input-group"><label for="simCustoFinMO">% Custo Financeiro sobre M.O.:</label><input type="text" id="simCustoFinMO"><span class="error-message" id="simCustoFinMOError"></span></div>
                    <div class="input-group"><label for="simTributosMO">% Tributos sobre M.O.:</label><input type="text" id="simTributosMO"><span class="error-message" id="simTributosMOError"></span></div>
                    <div class="input-group"><label for="simLucroMO">% Lucro Desejado sobre M.O.:</label><input type="text" id="simLucroMO"><span class="error-message" id="simLucroMOError"></span></div>
                </div>
                <div class="bdi-simulation-summary-factor"><strong>% BDI Bloco 1 (Fator): <span id="simBdiFatorMO">0,00%</span></strong></div>
                <div class="table-wrapper bdi-summary-table">
                    <table>
                        <thead><tr><th>Resumo Bloco 1 (Mão de Obra)</th><th>Valor (R$)</th></tr></thead>
                        <tbody id="simResumoBloco1Body">
                            <tr><td>Custo Mão de Obra</td><td data-value="custoMO">R$ 0,00</td></tr>
                            <tr><td>Valor Total (com BDI)</td><td data-value="totalComBdiMO">R$ 0,00</td></tr>
                            <tr><td>Valor Total - Imposto</td><td data-value="totalMenosImpostoMO">R$ 0,00</td></tr>
                            <tr><td>Lucro</td><td data-value="lucroMO">R$ 0,00</td></tr>
                            <tr><td>Porcentagem Lucro</td><td data-value="percLucroMO">0,00%</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="bdi-simulation-bloco">
                <h3>BLOCO 2: SIMULAÇÃO - CUSTOS INDIRETOS E LUCRO SOBRE MATERIAIS</h3>
                 <div class="bdi-simulation-grid-container">
                    <div class="input-group"><label for="simCustoDiretoMat">Custo Direto Materiais (R$):</label><input type="text" id="simCustoDiretoMat" readonly placeholder="R$ 0,00"></div>
                    <div class="input-group"><label for="simAdminMat">% Administração sobre Materiais:</label><input type="text" id="simAdminMat"><span class="error-message" id="simAdminMatError"></span></div>
                    <div class="input-group"><label for="simRiscoMat">% Risco sobre Materiais:</label><input type="text" id="simRiscoMat"><span class="error-message" id="simRiscoMatError"></span></div>
                    <div class="input-group"><label for="simCustoFinMat">% Custo Financeiro sobre Materiais:</label><input type="text" id="simCustoFinMat"><span class="error-message" id="simCustoFinMatError"></span></div>
                    <div class="input-group"><label for="simTributosMat">% Tributos sobre Materiais (ICMS, IPI, etc.):</label><input type="text" id="simTributosMat"><span class="error-message" id="simTributosMatError"></span></div>
                    <div class="input-group"><label for="simLucroMat">% Lucro Desejado sobre Materiais:</label><input type="text" id="simLucroMat"><span class="error-message" id="simLucroMatError"></span></div>
                </div>
                <div class="bdi-simulation-summary-factor"><strong>% BDI Bloco 2 (Fator): <span id="simBdiFatorMat">0,00%</span></strong></div>
                <div class="table-wrapper bdi-summary-table">
                    <table>
                        <thead><tr><th>Resumo Bloco 2 (Materiais)</th><th>Valor (R$)</th></tr></thead>
                        <tbody id="simResumoBloco2Body">
                            <tr><td>Custo Material</td><td data-value="custoMat">R$ 0,00</td></tr>
                            <tr><td>Valor Total (com BDI)</td><td data-value="totalComBdiMat">R$ 0,00</td></tr>
                            <tr><td>Valor Total - Imposto</td><td data-value="totalMenosImpostoMat">R$ 0,00</td></tr>
                            <tr><td>Lucro</td><td data-value="lucroMat">R$ 0,00</td></tr>
                            <tr><td>Porcentagem Lucro</td><td data-value="percLucroMat">0,00%</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="bdi-simulation-bloco">
                <h3>BLOCO 3: RESUMO DA SIMULAÇÃO (PREÇO DE VENDA BRUTO)</h3>
                <div class="table-wrapper bdi-summary-table">
                    <table >
                        <thead><tr><th>Descrição</th><th>Valor (R$)</th></tr></thead>
                        <tbody id="simResumoBloco3Body">
                            <tr><td>Valor Total (M.O. com BDI + Material com BDI)</td><td data-value="valorTotalSimulado">R$ 0,00</td></tr>
                            <tr><td>Valor Total - Impostos (M.O. + Material)</td><td data-value="valorTotalMenosImpostosSimulado">R$ 0,00</td></tr>
                            <tr><td>Custo Direto Total (Material + M.O)</td><td data-value="custoDiretoTotalSimulado">R$ 0,00</td></tr>
                            <tr><td>Lucro Total (M.O. + Material)</td><td data-value="lucroTotalSimulado">R$ 0,00</td></tr>
                            <tr><td>Porcentagem Lucro Total sobre Custo Direto</td><td data-value="percLucroTotalSimulado">0,00%</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="bdi-simulation-bloco">
                <h3>BLOCO 4: AJUSTES DE FATURAMENTO</h3>
                <div class="bdi-simulation-grid-container">
                    <div class="input-group"><label for="simPercFatMO">% Faturamento como M.O.:</label><input type="text" id="simPercFatMO"><span class="error-message" id="simPercFatMOError"></span></div>
                    <div class="input-group"><label for="simPercFatMat">% Faturamento como Material:</label><input type="text" id="simPercFatMat" readonly><span class="error-message" id="simPercFatMatError"></span></div>
                </div>
                <div class="table-wrapper bdi-summary-table">
                    <table>
                        <thead><tr><th>Descrição</th><th>Mão de Obra</th><th>Material</th></tr></thead>
                        <tbody id="simResumoBloco4AjusteBody">
                            <tr><td>Faturamento (%)</td><td data-value="faturamentoPercMO">0,00%</td><td data-value="faturamentoPercMat">0,00%</td></tr>
                            <tr><td>Valor Total (Faturado)</td><td data-value="valorTotalFaturadoMO">R$ 0,00</td><td data-value="valorTotalFaturadoMat">R$ 0,00</td></tr>
                            <tr><td>Imposto</td><td data-value="impostoValorMO">R$ 0,00</td><td data-value="impostoValorMat">R$ 0,00</td></tr>
                            <tr><td>Valor - Imposto</td><td data-value="valorMenosImpostoMO">R$ 0,00</td><td data-value="valorMenosImpostoMat">R$ 0,00</td></tr>
                        </tbody>
                    </table>
                </div>
                 <div class="table-wrapper bdi-summary-table" style="margin-top: 1rem;">
                    <table>
                        <thead><tr><th>Descrição</th><th>Valor (R$)</th></tr></thead>
                        <tbody id="simResumoBloco4FinalBody">
                            <tr><td>Valor Total (Faturado M.O. + Faturado Material)</td><td data-value="valorTotalFaturadoGeral">R$ 0,00</td></tr>
                            <tr><td>VALOR TOTAL - IMPOSTO (Faturado M.O. + Faturado Material)</td><td data-value="valorTotalFaturadoMenosImpostoGeral">R$ 0,00</td></tr>
                            <tr><td>Custo Direto Total (Material + M.O)</td><td data-value="custoDiretoTotalAjuste">R$ 0,00</td></tr>
                            <tr><td>Lucro (Ajustado pelo Faturamento)</td><td data-value="lucroAjustado">R$ 0,00</td></tr>
                            <tr><td>Porcentagem Lucro (Ajustado) sobre Custo Direto</td><td data-value="percLucroAjustado">0,00%</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Aba Resumo -->
        <div id="resumo" class="tab-content" role="tabpanel" aria-labelledby="tab-link-resumo">
            <h2>Resumo Financeiro do Orçamento</h2>
            <div id="resumoConteudo" class="resumo-layout-container">
                <div class="resumo-coluna">
                    <div class="resumo-item"><span class="resumo-label">Custo Total de Materiais:</span><span id="resumoTotalMateriais" class="resumo-valor">R$ 0,00</span></div>
                    <div class="resumo-item"><span class="resumo-label">Custo Total de Mão de Obra:</span><span id="resumoTotalMO" class="resumo-valor">R$ 0,00</span></div>
                    <div class="resumo-item"><span class="resumo-label">Custo Direto Total (CD):</span><span id="resumoCustoDireto" class="resumo-valor">R$ 0,00</span></div>
                </div>
                <div class="resumo-coluna">
                    <div class="resumo-item"><span class="resumo-label">Representatividade Materiais no Custo Direto:</span><span id="resumoPercentMaterialNoCD" class="resumo-valor">0,00%</span></div>
                    <div class="resumo-item"><span class="resumo-label">Representatividade M.O. no Custo Direto:</span><span id="resumoPercentMOnoCD" class="resumo-valor">0,00%</span></div>
                    <div class="resumo-item"><span class="resumo-label">Custo por m² (CD / Área):</span><span id="resumoCustoPorM2" class="resumo-valor">R$ 0,00 /m²</span></div>
                </div>
                <div class="resumo-coluna">
                    <div class="resumo-item"><span class="resumo-label">BDI Aplicado:</span><span id="resumoBDI" class="resumo-valor">0,00%</span></div>
                    <div class="resumo-item"><span class="resumo-label">Valor do BDI:</span><span id="resumoValorBDI" class="resumo-valor">R$ 0,00</span></div>
                </div>
                 <div class="resumo-coluna">
                    <div class="resumo-item total-geral"><span class="resumo-label">Preço de Venda Total (PV):</span><span id="resumoPrecoVenda" class="resumo-valor">R$ 0,00</span></div>
                     <div class="resumo-item"><span class="resumo-label">Preço de Venda por m² (PV / Área):</span><span id="resumoPrecoVendaPorM2" class="resumo-valor">R$ 0,00 /m²</span></div>
                </div>
            </div>
            <div class="graficos-container">
                <h3>Distribuição de Custos (Material vs. M.O.)</h3>
                <div class="grafico-wrapper" style="max-width: 400px; margin: 20px auto;">
                    <canvas id="graficoPizzaCustosCanvas"></canvas>
                </div>
            </div>
        </div>

        <!-- Aba Listas -->
        <div id="listas" class="tab-content" role="tabpanel" aria-labelledby="tab-link-listas">
            <h2>Listas de Materiais e Serviços</h2>
            <div class="listas-container"><section><h3>Lista de Serviços Quantificados</h3><div class="table-wrapper"><table id="tabelaListaServicos"><thead><tr><th>Serviço/Composição</th><th>Unidade</th><th>Quantidade</th><th>Custo Total (R$)</th></tr></thead><tbody></tbody></table></div></section><section><h3>Lista de Materiais Estimados</h3><div class="table-wrapper"><table id="tabelaListaMateriais"><thead><tr><th>Material</th><th>Unidade</th><th>Quantidade Estimada</th><th>Preço Unit. (R$)</th><th>Custo Total (R$)</th></tr></thead><tbody></tbody></table></div></section></div>
        </div>

        <!-- Aba Curva ABC -->
        <div id="curva-abc" class="tab-content" role="tabpanel" aria-labelledby="tab-link-curva-abc">
            <h2>Curva ABC de Serviços/Composições</h2>
            <p>A Curva ABC classifica os serviços/composições pela sua representatividade no custo total direto.</p>
            <div class="table-wrapper">
                <table id="tabelaCurvaABC">
                    <thead><tr><th>Serviço/Composição</th><th>Custo Total (R$)</th><th>% Individual</th><th>% Acumulada</th><th>Classe</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="graficos-container">
                <h3>Gráfico da Curva ABC</h3>
                <div class="grafico-wrapper" style="max-width: 800px; margin: 20px auto; height: 400px;">
                     <canvas id="graficoCurvaABCCanvas"></canvas>
                </div>
            </div>
        </div>

        <!-- Aba Cronograma -->
        <div id="cronograma" class="tab-content" role="tabpanel" aria-labelledby="tab-link-cronograma">
            <h2>Cronograma Físico-Financeiro Estimado</h2>
            <p>Uma estimativa simplificada da distribuição dos custos ao longo do tempo.</p>
            <div class="input-group" style="max-width: 300px;"><label for="inputDuracaoEstimada">Duração Estimada da Obra (meses):</label><input type="number" id="inputDuracaoEstimada" value="6" min="1" step="1"><span class="error-message" id="inputDuracaoEstimadaError"></span></div>
            <div class="table-wrapper"><table id="tabelaCronograma"><thead><tr><th>Mês</th><th>% Desembolso Acumulado (Estimado)</th><th>Valor Desembolsado no Mês (R$)</th><th>Valor Acumulado Desembolsado (R$)</th></tr></thead><tbody></tbody></table></div>
            <div class="graficos-container">
                <h3>Gráfico de Gantt Estimado</h3>
                <div class="grafico-wrapper">
                    <div id="graficoGanttContainer" style="margin: 20px 0;">
                        <svg id="graficoGantt"></svg>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <p>&copy; <span id="currentYear"></span> Calculadora de Orçamento. Todos os direitos reservados.</p>
    </footer>

    <script type="module" src="js/main.js"></script>
</body>
</html>